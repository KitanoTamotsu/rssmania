## 　　Lesson14.　RSSやHTMLをパースする/出力する一覧をコントロールする 

[サンプル動画](https://user-images.githubusercontent.com/40127279/126052092-d459abff-728d-4de4-a7b7-256f2407c8dd.mp4)

#### 開発メモ
ワークフロー
<img width="600" src="https://user-images.githubusercontent.com/40127279/127756010-7b080e13-334b-4881-bdda-f7d2129ca5b8.png">

### 1.パラメータで表示させる記事の一覧をコントロールさせるアイディア
　Alfredのアウトプットは9件表示させることができます
<br>　でもニュースサイトなどのRSSの記事が9件以上あることもしばしば
<br>　そこで、パラメータの文字数とページを紐づけることを考えました
<br>　
<br>　即ち
<br>　"rss a"というキーワードでサイトAのRSSの1件目から9件目を表示
<br>　"rss a+"と1文字"+"を追加したら、サイトAのRSSの10件目から18件目を表示
<br>　"rss a++"とさら"+"を追加したら、サイトAのRSSの19件目から27件目を表示
<br>　
<br>　もちろん、ここで
<br>　"rss a+"と"+"を削除したら、サイトAのRSSの10件目から18件目に戻るという風に
<br>　
<br>　実装の段階でrssは"rss a"から"rss z"の26種類としたので"+"ではなく、
<br>　どの文字を続けて書いてもOKとしました。"rss kkk"みたいな続け打ちができます
### 2.パラメータで表示させる記事の一覧をコントロールを実装する
　出力するJSONフォーマットは、他のワークフローと同様に配列を利用して作成しています
<br>　肝は入力パラメータの文字数（ページ数）と、ループさせる配列の添字を関連づけること
<br>　入力パラメータの文字数は＄{#1}で取得できることが分かったので、あとは計算だけですね
<br> 
<br>　パラメータの文字数（ページ数）　1、 2、 3、 4、・・・
<br>　各ページのトップ記事の添字　　　0、 9、18、27、・・・
<br>
<br>　記事は9件分なので9回ループさせて配列からJSONフォーマットを作成すればOK
<br>　ループのさせ方は色々あるかと思うので、どのような実装でもかまいません
### 3.ソースを解釈する（	RSSパース）
　今回力技で26個のサイトRSSやHTMLをパースしたのですが、そのおかげで、
<br>　grepやsedや配列が、なんとなく理解できました
<br>　以下ポイントです
### 3-1.配列への代入はスペース区切りの文字列を括弧でくくるだけ
```
　　　hairetu=("foo" "bar" "bee" "boo")　
```
<br>　とすると
```
　　　hairetu[0]に"foo"
　　　hairetu[1]に"bar"
　　　hairetu[2]に"bee"
　　　hairetu[3]に"boo"
```
<br>　とそれぞれ格納されます
<br>　
<br>　そのためタグの情報をスペース区切りで取り出せば、簡単に配列とすることができます
<br>　準備する配列は最低2つ。記事のタイトルと記事へのリンクです
<br>　あとはサブタイトルとして記事の日付をいれることにしました
<br>　
<br>　イメージ（ブランクを△で明示しています）
<br>　タイトル用配列 ＝（"タイトル1"△"タイトル2"△"タイトル3"…）
<br>　リンク用配列 ＝（URL1"△"URL2"△"URL3"…）
<br>　サブタイトル用配列 ＝（"日付1"△"日付2"△"日付3"…）
<br>　　
<br>　ここで気をつけなければならないのは、取り出す情報の中にブランクがないこと
<br>　ブランクがあると順番が狂ってしまい、抽出した情報間で整合性がとれなくなります
<br>　（例えば、タイトルの個数・順番と、URLの個数・順番に不一致が生じで、
<br>　同じ添字がつかえなくなっちゃうので）
<br>　
<br>　rss aのScriptFilterのコードをサンプルとして掲載し、以下で解説します
<img width="600" src="https://user-images.githubusercontent.com/40127279/127756053-3b078701-c41a-4861-b956-a354184520a9.png">


### 3-2.RSS情報を取得する
　curlで取得します。RSSでもHTMLでも同じです。ソースが受け取れます
<br>　スクリプトをみると-sLのオプションが付いているものと、ついていないものがありますが、
<br>　基本どっちでも良いです。というのも
<br>　
<br>　-sはサイレントの意味で余計なものは不要という指定です
<br>　エラーを確認するような場合には外す方がよいかもしれませんが、
<br>　パイプで後続に渡す時には、つけることがよくあるそうです
<br>　
<br>　-Lはリダイレクトを許可するオプションです
<br>　リダイレクトするということはURLを変更した可能性があるので
<br>　リダイレクトを許可せず、エラーとなったら確認するという方針でOKです
<br>　
<br>　オプションがバラバラなのは、表示できれば気にしないという方針ですので。悪しからず
<br>　
<br>　curlでソースを取得した後に、sedでスペースを削除しています
<br>　上述のブランクが残ることによって配列が乱れることを防止するためです
<br>　下記のコードです   
```
　　sed 's/ //g'
``` 
### 3-3.欲しい情報を取得する（コア）
　欲しい情報はタグの中身です。例えば記事のタイトルであれば、以下タグのxxxxxxの部分。
```
　　<title>xxxxxx</title>
```
<br>　基本的にgrepのoオプションで対象のタグを取り出します
<br>　ちなみに、Eオプションは拡張正規表現の利用とのことですので、なんとなくつけたままです
<br>　下記のようにするとソース内のすべてのタイトルタグをスペース区切りで取り出してくれます
<br>　スペース区切りなので配列に格納するのにちょうどよいですね
```
　　grep -oE '<title>[^<]+</title>'
```
<br>　[^<]+というのは『<』以外の文字の連続を指定する部分がミソで、
<br>　ここを任意の文字の連続とすると一番最後の</title>までがマッチします（全体で1個）
<br>　
<br>　次にsedで取り出します
```
　　sed 's#<title>\(.*\)</title>#\1#'
```
<br>　普通のsed sコマンドは/で区切るのですが#でもOKです
<br>　今回は終了タグの/があるので、見易さを意識して#を使いまいした
<br>　記号が3つあればOKらしく@を使った例もありますね
<br>　
<br>　タグの中身を取り出すためには括弧を使います
<br>　置換対象の文字列はバックスラッシュのエスケープを外すとこんな感じ
```
　　<title>(.*)</title>
```
<br>　置換後の\1は1組目の括弧を意味しています（今回は1組しかないですが）
<br>　つまり、sedの命令は、titleタグ全体をその中身の『.*』に置き換えるという意味になります
<br>　
<br>　なお最後にgがついていませんが、grep -oのパイプの場合はこれでOKです
<br>　内部的な動きがあるのでしょう
<br>　因みにgrepとsedを分ける場合はgをつけたり、Eオプションで正規表現にしたりする必要が
<br>　ありました
<br>　最後は配列への格納ですがスペース区切りになっているので、
<br>　結果をそのまま括弧で括って変数に格納します
```
　　title=(`xxxxx`)
```
<br>　xxxxxの部分は上記のgrepやsedをechoしたもので、すでにスペースで区切られています
<br>　スクリプトやAlfredのデバッグツールで確認してみてください（確認用のechoが必要ですが）
### 3-4.欲しい情報を取得する（バリエーションへの対応）
　RSSの場合は、記事のリンクはlinkタグ、日付はpubDateタグやdc:dateタグと
<br> ある程度ルールがあるようです
<br>　HTMLの場合はCLASS指定を目印にするのがよいでしょう
<br>　Aタグ、tdタグ、Hタグだけでは特定が困難で、配列に入れるための順序を保てないと思います
<br>　
<br>　rss f、rss h、rss m、rss v、rss xのスクリプトを見てもらえれば、力技の苦労がわかるかな
<br>　ただ1度HTMLからの抽出に成功すると、他にもやりたくなってしまいます
<br>　パズルのノリです
### 4.AlfredのJSONフォーマットを作成する
　情報が抽出できればあとはJSONを作るだけです
<br>　titleは文字数が長いとAlfredの出力で『…』として中略されるので長さを制限しています
<br>　linkはHTMLの場合相対パスで書いているものもあるので適宜補う必要があったりします
<br>　subtitleは日付にしましたが物によって編集が必要です
<br>　まあ大したことなないですね
### 5.苦労したことをすこしだけ
　基本的にカリカリとひたすらスクリプトを作りました
<br>　ちょっと苦労したポイントです
<br>　
<br>　・MedicalDOC
<br>　　RSSではなくHTMLをパースしています
<br>　
<br>　・カラパイア
<br>　　もともと"rss k"で作成したのですがカラパイアのRSSが重たかったので一旦あきらめました
<br>　　その後まとめブログアンテナを発見HTMLでパースしてみました
<br>　　まだ、ちょっと反応遅いけど"rss x"として復活
<br>　
<br>　・秒刊SUNDAY
<br>　　苦労ということでは無いですが、こちらも件数が多く重たいです　
<br>　
<br>　・RSS F
<br>　　スクリプトの苦労ではないのですが、良さそうなRSSが発見できませんでした
<br>　　FNNプライムオンラインのニュースとしていましたが天気.jpのサプリ記事にしました
<br>　　Fから連想できない。。。
<br>　　HTMLをパースしていますが、タグの個数を合わせるために、いったん段落を抽出しています
<br>　　リンクのパスが相対パスでしたのでドメイン部分等追加しています
<br>　
<br>　・オブジェクトが多い
<br>　　Script Filterをたくさん配置しています
<br>　　ロジックは同じようなものなのでコピペでつくったのですがピッタリ重なったりする
<br>　　ことがあります。隠れたオブジェクトが稼働しているとデバッグしにくいです
<br>　　（修正しても直らないという謎の現象が発生します）
<br>　　あと、間違ったオブジェクトに接続されるとおかしな動きをします
<br>　
<br>　以下、イニシャル文字と表示させるRSSの一覧です
<br>　　A: All About(新着記事)
<br>　　 　さまざまなジャンルの専門家によるコンテンツが充実した総合情報サイト
<br>　
<br>　　B: 秒刊SUNDAY
<br>　　   炎上を利用して人気を集めるブログ風ニュースサイト
<br>　
<br>　　C: CREA
<br>　　　 知的好奇心旺盛な女性のためのこだわりの総合月刊誌CREAの公式サイト
<br>　
<br>　　D: Daily News Agency
<br>　　   世界で起こったもろもの面白いことを発信するニュースサイト
<br>　
<br>　　E: ESSE (Yahoo rss)
<br>  　　 生活情報誌「ESSE」の記事と周辺情報をベースにした生活情報誌サイト
<br>　
<br>　　F: 天気.jp　サプリ記事
<br>   　　日本気象協会公式サイトのコラム記事。季節の話題を提供
<br>　
<br>　　G: GIZMODO 
<br>   　　メディアジーンが運営する日本最大のテクノロジー情報サイト
<br>　
<br>　　H: ダ・ヴィンチニュース　人気の本・小説ランキング
<br>   　　本のランキング。更新頻度はあまりないかな
<br>　
<br>　　I: ITmediaニュース新着記事
<br>   　　ソフトバンクグループ傘下のアイティメディアが運営するIT系ニュースサイト
<br>　
<br>　　J: J-CASTニュース
<br>   　　『Jカス』で検索ヒットするニュースサイト。カス丸くんがイメージキャラ
<br>　
<br>　　K: goo急上昇ワード
<br>   　　goo検索の急上昇ワード
<br>　
<br>　　L: ねとらぼ
<br>   　　ネット上の旬な情報を国内外からジャンルを問わず紹介する情報サイト
<br>　
<br>　　M: MedicalDOC コラム
<br>   　　多数のドクターと作った身近な医療情報サイト
<br>　
<br>　　N: ナショナルジオグラフィック日本語版　
<br>   　　品質の高い写真と自然科学の記事を配信するサイト
<br>　
<br>　　O: 教えて！goo 最新の質問
<br>   　　よろず相談サイトみんなの質問に答えましょう
<br>　
<br>　　P: ネタとぴ
<br>  　　やじうまネタ配信サイト
<br>　
<br>　　Q: QJweb (Yahoo rss)
<br>   　　1994年刊行の雑誌『クイック・ジャパン』から生まれたウェブニュースメディア
<br>　
<br>　　R: ロケットニュース24
<br>　　　　くだらなくておもしろい出来事などを8割くらいの力で配信するサイト
<br>　
<br>　　S: sorae (Yahoo rss)
<br>   　　宇宙や天文のニュースを中心に『そら』に関する情報を提供するサイト
<br>　
<br>　　T: TOCANA
<br>   　　世の中の不思議やオカルトを集めたサイト。『ほんとかな』の『とかな』
<br>　
<br>　　U: 虚構新聞
<br>   　　個人が発信する嘘のニュースサイト。たまに嘘が本当になって誤報の謝罪があるとか
<br>　
<br>　　V: ダ・ヴィンチニュース　毎日雑学
<br>   　　書籍に関するニュース発信サイト。雑学コーナーの一覧ページをパースしてみました
<br>　
<br>　　W: ついラン
<br>   　　Twitterでのつぶやきの数を基にランキング
<br>　
<br>　　X: カラパイ（まとめブログアンテナ）
<br>   　　不思議と謎と超常現象のニュースサイト。未知を表すXで
<br>　
<br>　　Y: zakzak by 夕刊フジ
<br>   　　オレンジ色の憎い奴夕刊フジの公式ニュースサイト
<br>　
<br>　　Z: Gigazine
<br>   　　ギガジン＝ギガバイト＋マガジン。老舗ニュースサイト
<br>
<br>　　　　あー疲れた
<br>
　
<br>
#### 背景
　nature remoのworkflowで"vol ++"を実装した時に思いつきました
<br>　RSSの"rss +++"みたいな入力で、表示させる一覧のページ替えをさせたいなぁと
<br>　多分Alfredで一番応用ができそうな使い方ではないかな
<br>　あとAlfred出力フォーマットのアイコンで記事ごとの画像がのせられると良いかも　
<br>　
#### 取扱説明
### 機能:
　複数のRSSをパースして個々の記事の一覧をalfredの出力フォーマットに表示させる
<br>　
### インストール:
　1.[Alfredworkflow](https://github.com/KitanoTamotsu/rssmania/releases/download/1.4/RSSmania.alfredworkflow.zip)をダウンロード 
<br>　2.ファイルをダブルクリックしてワークフローに登録
### 使い方:
　キーワード『rss x』で起動(xは任意の英字）
<br>　xの後に何か文字を続けると、次の記事一覧を表示
#### 修正履歴
### Ver1.1(2021-03-28)：
　・ScriptFilterのJSONフォーマットの編集をワンライナーから1行1プロパティーに変更
<br>
<br>　修正前の例
```
　json=$json'{"title":"'${title[i]:0:24}'","subtitle":"'${sub[i]:9:4}${sub[i]:6:3}${sub[i]:4:2}'","arg": "'${link[i]}'"}'
``` 
<br>　修正後の例
```
  json=$json'{"title":"'${title[i]:0:24}'",'
  json=$json'"subtitle":"'${sub[i]:9:4}${sub[i]:6:3}${sub[i]:4:2}'",'
  json=$json'"arg": "'${link[i]}'"}' 
```
<br>　・ソースとは関係ありませんが、サンプル動画を投稿
<br>
### ver1.2(2021-04-04)：
　シェルスクリプトをbashからzshに変更
<br>
### ver1.3(2021-04-24)：
　ループ数の算出ロジックの誤りを修正（お恥ずかしい）
<br>　　誤）　val2=$(($val1+9))
<br>　　正）　val2=$(($val1+8))
<br>　　誤のロジックの場合、Alfred出力が10行になります
<br>　　そのままでは10行目は表示はされませんが、↓キーを押して行くと表示されます
<br>
### ver1.4(2021-06-17)：
　『rss v』を『goo ランキング』に変更
<br>　以前は『ダ・ヴィンチニュース　毎日雑学』でしたが4月から更新がないので変更
<br>　
<br>
[トップページに戻る](https://kitanotamotsu.github.io/)

